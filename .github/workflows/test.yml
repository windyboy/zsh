name: Test ZSH Configuration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: zsh {0}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        zsh-version: [5.8, 5.9]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup ZSH
      run: |
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          sudo apt-get update
          sudo apt-get install -y zsh
        elif [[ "$RUNNER_OS" == "macOS" ]]; then
          brew install zsh
        fi
        
        echo "ZSH_VERSION=$(zsh --version | head -1)" >> $GITHUB_ENV
        
    - name: Install dependencies
      run: |
        # Install basic tools
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          sudo apt-get install -y git curl wget bc
        elif [[ "$RUNNER_OS" == "macOS" ]]; then
          brew install git curl wget bc
        fi
        
        # Install optional tools for testing
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          sudo apt-get install -y fzf
        elif [[ "$RUNNER_OS" == "macOS" ]]; then
          brew install fzf
        fi
        
    - name: Setup ZSH configuration
      run: |
        # Create necessary directories
        mkdir -p ~/.config/zsh ~/.cache/zsh ~/.local/share/zsh
        
        # Copy configuration files
        cp -r . ~/.config/zsh/
        
        # Set environment variables
        echo 'export ZSH_CONFIG_DIR="$HOME/.config/zsh"' >> ~/.zshenv
        echo 'export ZSH_CACHE_DIR="$HOME/.cache/zsh"' >> ~/.zshenv
        echo 'export ZSH_DATA_DIR="$HOME/.local/share/zsh"' >> ~/.zshenv
        
    - name: Run syntax validation
      run: |
        echo "🔍 Validating ZSH syntax..."
        
        # Check main configuration files
        zsh -n ~/.config/zsh/zshrc || exit 1
        zsh -n ~/.config/zsh/zshenv || exit 1
        
        # Check all module files
        for file in ~/.config/zsh/modules/*.zsh; do
          if [[ -f "$file" ]]; then
            echo "Checking: $file"
            zsh -n "$file" || exit 1
          fi
        done
        
        echo "✅ All syntax validation passed"
        
    - name: Run configuration tests
      run: |
        echo "🧪 Running configuration tests..."
        
        # Source configuration
        source ~/.config/zsh/zshrc
        
        # Run basic tests
        ./test.sh unit || exit 1
        ./test.sh integration || exit 1
        
        echo "✅ Configuration tests passed"
        
    - name: Run performance tests
      run: |
        echo "⚡ Running performance tests..."
        
        # Source configuration
        source ~/.config/zsh/zshrc
        
        # Run performance tests
        ./test.sh performance || exit 1
        
        echo "✅ Performance tests passed"
        
    - name: Run plugin tests
      run: |
        echo "🔌 Running plugin tests..."
        
        # Source configuration
        source ~/.config/zsh/zshrc
        
        # Run plugin tests
        ./test.sh plugins || exit 1
        
        echo "✅ Plugin tests passed"
        
    - name: Run security tests
      run: |
        echo "🛡️ Running security tests..."
        
        # Source configuration
        source ~/.config/zsh/zshrc
        
        # Run security tests
        ./test.sh security || exit 1
        
        echo "✅ Security tests passed"
        
    - name: Run status check
      run: |
        echo "📊 Running status check..."
        
        # Source configuration
        source ~/.config/zsh/zshrc
        
        # Run status check
        ./status.sh --verbose || exit 1
        
        echo "✅ Status check passed"
        
    - name: Run project health check
      run: |
        echo "🔍 Running project health check..."
        
        # Run health check
        ./check-project.sh || exit 1
        
        echo "✅ Project health check passed"
        
    - name: Test plugin installation
      run: |
        echo "🔌 Testing plugin installation..."
        
        # Test plugin installation
        ./install-plugins.sh install || exit 1
        ./install-plugins.sh health || exit 1
        
        echo "✅ Plugin installation test passed"
        
    - name: Validate documentation
      run: |
        echo "📚 Validating documentation..."
        
        # Check if README exists
        [[ -f README.md ]] || exit 1
        
        # Check if CHANGELOG exists
        [[ -f CHANGELOG.md ]] || exit 1
        
        # Check if REFERENCE exists
        [[ -f REFERENCE.md ]] || exit 1
        
        echo "✅ Documentation validation passed"
        
    - name: Check file permissions
      run: |
        echo "🔐 Checking file permissions..."
        
        # Check script permissions
        chmod +x ~/.config/zsh/*.sh
        chmod +x ~/.config/zsh/install-plugins.sh
        
        # Verify permissions
        [[ -x ~/.config/zsh/install.sh ]] || exit 1
        [[ -x ~/.config/zsh/status.sh ]] || exit 1
        [[ -x ~/.config/zsh/test.sh ]] || exit 1
        
        echo "✅ File permissions check passed"
        
    - name: Performance benchmark
      run: |
        echo "📈 Running performance benchmark..."
        
        # Source configuration and measure startup time
        start_time=$(date +%s.%N)
        source ~/.config/zsh/zshrc >/dev/null 2>&1
        end_time=$(date +%s.%N)
        
        startup_time=$(echo "$end_time - $start_time" | bc)
        
        echo "Startup time: ${startup_time}s"
        
        # Check if startup time is acceptable (< 2 seconds)
        if (( $(echo "$startup_time > 2" | bc -l) )); then
          echo "❌ Startup time too slow: ${startup_time}s"
          exit 1
        else
          echo "✅ Startup time acceptable: ${startup_time}s"
        fi
        
    - name: Generate test report
      run: |
        echo "📊 Generating test report..."
        
        # Create test report
        {
          echo "# ZSH Configuration Test Report"
          echo "Generated: $(date)"
          echo "OS: $RUNNER_OS"
          echo "ZSH Version: $ZSH_VERSION"
          echo
          echo "## Test Results"
          echo "- ✅ Syntax validation: PASSED"
          echo "- ✅ Configuration tests: PASSED"
          echo "- ✅ Performance tests: PASSED"
          echo "- ✅ Plugin tests: PASSED"
          echo "- ✅ Security tests: PASSED"
          echo "- ✅ Status check: PASSED"
          echo "- ✅ Project health: PASSED"
          echo "- ✅ Plugin installation: PASSED"
          echo "- ✅ Documentation: PASSED"
          echo "- ✅ File permissions: PASSED"
          echo "- ✅ Performance benchmark: PASSED"
        } > test-report.md
        
        echo "✅ Test report generated"
        
    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: test-report-${{ matrix.os }}
        path: test-report.md
        
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        severity: warning
        shell: bash
        ignore_paths: |
          themes/**
          modules/**
          completions/**
          **/*.zsh
        
    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        args: --only-verified --fail
